<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Chat Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .user-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .user-panel h2 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }
        
        .login-form {
            margin-bottom: 20px;
        }
        
        .login-form input, .login-form button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .login-form button {
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        
        .login-form button:hover {
            background: #0056b3;
        }
        
        .rooms-list {
            margin: 20px 0;
        }
        
        .room-item {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .room-item:hover {
            background: #e9ecef;
        }
        
        .room-item.active {
            background: #007bff;
            color: white;
        }
        
        .chat-area {
            height: 300px;
            border: 1px solid #ddd;
            overflow-y: auto;
            padding: 10px;
            background: white;
            margin: 10px 0;
        }
        
        .message {
            margin: 8px 0;
            padding: 8px;
            border-radius: 4px;
            background: #f8f9fa;
        }
        
        .message.own {
            background: #007bff;
            color: white;
            text-align: right;
        }
        
        .message-input {
            display: flex;
            gap: 10px;
        }
        
        .message-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .message-input button {
            padding: 8px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .status {
            font-size: 12px;
            color: #666;
            margin: 5px 0;
        }
        
        .status.connected { color: #28a745; }
        .status.error { color: #dc3545; }
        
        .create-chat {
            margin: 15px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 4px;
        }
        
        .create-chat input, .create-chat button {
            margin: 5px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .create-chat button {
            background: #17a2b8;
            color: white;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>üß™ Real-Time Chat Test - WebSocket Fix Verification</h1>
    <p>This test helps verify that the WebSocket connection issue has been resolved and both users can see each other's messages in real-time.</p>
    
    <div class="test-container">
        <!-- User 1 Panel -->
        <div class="user-panel">
            <h2>üë§ User 1 - AashiJain</h2>
            
            <div class="login-form">
                <input type="email" id="email1" value="aashij971@gmail.com" placeholder="Email">
                <input type="password" id="password1" value="password123" placeholder="Password">
                <button onclick="loginUser(1)">üîê Login</button>
            </div>
            
            <div class="status" id="status1">Not logged in</div>
            
            <div class="create-chat">
                <h4>Create Direct Chat</h4>
                <input type="email" id="chat-email1" value="mondalanwesa0@gmail.com" placeholder="Other user email">
                <button onclick="createChat(1)">üí¨ Create Chat</button>
            </div>
            
            <div class="rooms-list">
                <h4>üìÇ Chat Rooms</h4>
                <div id="rooms1"></div>
            </div>
            
            <div class="chat-area" id="chat1"></div>
            
            <div class="message-input">
                <input type="text" id="message1" placeholder="Type a message..." onkeypress="handleKeyPress(event, 1)">
                <button onclick="sendMessage(1)">üì§ Send</button>
            </div>
        </div>
        
        <!-- User 2 Panel -->
        <div class="user-panel">
            <h2>üë§ User 2 - AnwesaMondal</h2>
            
            <div class="login-form">
                <input type="email" id="email2" value="mondalanwesa0@gmail.com" placeholder="Email">
                <input type="password" id="password2" value="password123" placeholder="Password">
                <button onclick="loginUser(2)">üîê Login</button>
            </div>
            
            <div class="status" id="status2">Not logged in</div>
            
            <div class="create-chat">
                <h4>Create Direct Chat</h4>
                <input type="email" id="chat-email2" value="aashij971@gmail.com" placeholder="Other user email">
                <button onclick="createChat(2)">üí¨ Create Chat</button>
            </div>
            
            <div class="rooms-list">
                <h4>üìÇ Chat Rooms</h4>
                <div id="rooms2"></div>
            </div>
            
            <div class="chat-area" id="chat2"></div>
            
            <div class="message-input">
                <input type="text" id="message2" placeholder="Type a message..." onkeypress="handleKeyPress(event, 2)">
                <button onclick="sendMessage(2)">üì§ Send</button>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:8000';
        
        // User state
        const users = {
            1: { token: null, username: null, rooms: [], selectedRoom: null, websocket: null },
            2: { token: null, username: null, rooms: [], selectedRoom: null, websocket: null }
        };
        
        // Utility function for authenticated fetch
        async function authenticatedFetch(url, options = {}, token, maxRetries = 3) {
            const headers = {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` }),
                ...options.headers
            };
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(url, { ...options, headers });
                    
                    if (response.ok) {
                        return response;
                    } else if (response.status >= 500 && attempt < maxRetries) {
                        console.log(`Attempt ${attempt} failed with ${response.status}, retrying...`);
                        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                    } else {
                        return response;
                    }
                } catch (error) {
                    if (attempt < maxRetries) {
                        console.log(`Attempt ${attempt} failed with error: ${error.message}, retrying...`);
                        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                    } else {
                        throw error;
                    }
                }
            }
        }
        
        // Login user
        async function loginUser(userNum) {
            const email = document.getElementById(`email${userNum}`).value;
            const password = document.getElementById(`password${userNum}`).value;
            
            updateStatus(userNum, "Logging in...");
            
            try {
                const response = await authenticatedFetch(`${BASE_URL}/auth/login`, {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    users[userNum].token = data.access_token;
                    users[userNum].username = data.username;
                    updateStatus(userNum, `‚úÖ Logged in as ${data.username}`, 'connected');
                    
                    // Load rooms after login
                    await loadRooms(userNum);
                } else {
                    const errorData = await response.json();
                    updateStatus(userNum, `‚ùå Login failed: ${errorData.detail}`, 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                updateStatus(userNum, `‚ùå Login error: ${error.message}`, 'error');
            }
        }
        
        // Create chat room
        async function createChat(userNum) {
            const email = document.getElementById(`chat-email${userNum}`).value;
            const token = users[userNum].token;
            
            if (!token) {
                updateStatus(userNum, "‚ùå Please login first", 'error');
                return;
            }
            
            updateStatus(userNum, "Creating chat...");
            
            try {
                const response = await authenticatedFetch(`${BASE_URL}/chat/rooms`, {
                    method: 'POST',
                    body: JSON.stringify({
                        type: "direct",
                        members: [email]
                    })
                }, token);
                
                if (response.ok) {
                    const room = await response.json();
                    updateStatus(userNum, `‚úÖ Chat created: ${room.name}`, 'connected');
                    await loadRooms(userNum);
                } else {
                    const errorData = await response.json();
                    updateStatus(userNum, `‚ùå Chat creation failed: ${errorData.detail}`, 'error');
                }
            } catch (error) {
                console.error('Chat creation error:', error);
                updateStatus(userNum, `‚ùå Chat creation error: ${error.message}`, 'error');
            }
        }
        
        // Load user rooms
        async function loadRooms(userNum) {
            const token = users[userNum].token;
            
            try {
                const response = await authenticatedFetch(`${BASE_URL}/chat/rooms`, {}, token);
                
                if (response.ok) {
                    const rooms = await response.json();
                    users[userNum].rooms = rooms;
                    displayRooms(userNum);
                } else {
                    updateStatus(userNum, "‚ùå Failed to load rooms", 'error');
                }
            } catch (error) {
                console.error('Load rooms error:', error);
                updateStatus(userNum, `‚ùå Load rooms error: ${error.message}`, 'error');
            }
        }
        
        // Display rooms
        function displayRooms(userNum) {
            const roomsContainer = document.getElementById(`rooms${userNum}`);
            const rooms = users[userNum].rooms;
            
            roomsContainer.innerHTML = '';
            
            rooms.forEach(room => {
                const roomDiv = document.createElement('div');
                roomDiv.className = 'room-item';
                roomDiv.textContent = `${room.name} (${room.type})`;
                roomDiv.onclick = () => selectRoom(userNum, room);
                roomsContainer.appendChild(roomDiv);
            });
        }
        
        // Select room and connect WebSocket
        async function selectRoom(userNum, room) {
            // Disconnect previous WebSocket
            if (users[userNum].websocket) {
                users[userNum].websocket.close();
                users[userNum].websocket = null;
            }
            
            users[userNum].selectedRoom = room;
            
            // Update room selection UI
            document.querySelectorAll(`#rooms${userNum} .room-item`).forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateStatus(userNum, `Connecting to ${room.name}...`);
            
            // Connect WebSocket to room
            connectToRoom(userNum, room.id);
            
            // Load messages
            await loadMessages(userNum, room.id);
        }
        
        // Connect to room WebSocket
        function connectToRoom(userNum, roomId) {
            const token = users[userNum].token;
            const wsUrl = `ws://localhost:8000/ws/chat/${roomId}?token=${token}`;
            
            console.log(`[User ${userNum}] Connecting to room WebSocket: ${roomId}`);
            
            const ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log(`[User ${userNum}] Room WebSocket connected`);
                updateStatus(userNum, `‚úÖ Connected to ${users[userNum].selectedRoom.name}`, 'connected');
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log(`[User ${userNum}] WebSocket message:`, data);
                
                if (data.type === 'new_message') {
                    displayMessage(userNum, data.message);
                } else if (data.type === 'connected') {
                    updateStatus(userNum, `‚úÖ Connected to room with ${data.online_users?.length || 0} users`, 'connected');
                }
            };
            
            ws.onerror = (error) => {
                console.error(`[User ${userNum}] Room WebSocket error:`, error);
                updateStatus(userNum, "‚ùå WebSocket connection error", 'error');
            };
            
            ws.onclose = (event) => {
                console.log(`[User ${userNum}] Room WebSocket disconnected: Code ${event.code}`);
                if (event.code === 403) {
                    updateStatus(userNum, "‚ùå Access denied to room", 'error');
                } else {
                    updateStatus(userNum, "‚ö†Ô∏è WebSocket disconnected", 'error');
                }
            };
            
            users[userNum].websocket = ws;
        }
        
        // Load messages for room
        async function loadMessages(userNum, roomId) {
            const token = users[userNum].token;
            
            try {
                const response = await authenticatedFetch(`${BASE_URL}/chat/rooms/${roomId}/messages`, {}, token);
                
                if (response.ok) {
                    const messages = await response.json();
                    const chatArea = document.getElementById(`chat${userNum}`);
                    chatArea.innerHTML = '';
                    
                    messages.forEach(message => {
                        displayMessage(userNum, message);
                    });
                }
            } catch (error) {
                console.error('Load messages error:', error);
            }
        }
        
        // Display message in chat
        function displayMessage(userNum, message) {
            const chatArea = document.getElementById(`chat${userNum}`);
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            // Check if this is user's own message
            if (message.sender_username === users[userNum].username) {
                messageDiv.classList.add('own');
            }
            
            const timestamp = new Date(message.created_at).toLocaleTimeString();
            messageDiv.innerHTML = `<strong>${message.sender_username}</strong> <small>${timestamp}</small><br>${message.content}`;
            
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        
        // Send message
        async function sendMessage(userNum) {
            const messageInput = document.getElementById(`message${userNum}`);
            const content = messageInput.value.trim();
            const token = users[userNum].token;
            const room = users[userNum].selectedRoom;
            
            if (!content || !token || !room) {
                return;
            }
            
            try {
                const response = await authenticatedFetch(`${BASE_URL}/chat/rooms/${room.id}/messages`, {
                    method: 'POST',
                    body: JSON.stringify({
                        content: content
                    })
                }, token);
                
                if (response.ok) {
                    messageInput.value = '';
                    // Message will be displayed via WebSocket
                } else {
                    updateStatus(userNum, "‚ùå Failed to send message", 'error');
                }
            } catch (error) {
                console.error('Send message error:', error);
                updateStatus(userNum, `‚ùå Send message error: ${error.message}`, 'error');
            }
        }
        
        // Handle Enter key for message input
        function handleKeyPress(event, userNum) {
            if (event.key === 'Enter') {
                sendMessage(userNum);
            }
        }
        
        // Update status display
        function updateStatus(userNum, message, type = '') {
            const statusElement = document.getElementById(`status${userNum}`);
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            
            console.log(`[User ${userNum}] ${message}`);
        }
        
        // Initial setup
        console.log('üß™ Real-time chat test loaded. Please login both users and create/select rooms to test messaging.');
    </script>
</body>
</html>